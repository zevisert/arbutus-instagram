<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>arbutus-instagram test</title>

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>

    <link rel="import" href="../arbutus-instagram.html">
  </head>
  <body>

    <test-fixture id="BasicTestFixture">
      <template>
        <arbutus-instagram></arbutus-instagram>
      </template>
    </test-fixture>
    
    <test-fixture id="ShortcodeTestFixture">
      <template>
        <arbutus-instagram shortcode="BSrtEwZF3xV"></arbutus-instagram>
      </template>
    </test-fixture>

    <script>
      suite('arbutus-instagram', () => {

        test('instantiating the element sprouts default properties', () => {
          const element = fixture('BasicTestFixture');
          expect(element.getAttributeNames()).to.include.members(['clientid', 'redirecturi', 'caption']);
        });

        test('changes to client id and redirect uri reflect between attribute and property', () => {
          const element = fixture('BasicTestFixture');
          
          const ID1 = "1111";
          element.clientid = ID1;
          expect(element.clientid).to.equal(ID1);
          expect(element.getAttribute('clientid')).to.equal(ID1);

          const ID2 = "2222";
          element.setAttribute('clientid', ID2);
          expect(element.clientid).to.equal(ID2);
          expect(element.getAttribute('clientid')).to.equal(ID2);

          const URI1 = "https://local.testing/callback/1111";
          element.redirecturi = URI1;
          expect(element.redirecturi).to.equal(URI1);
          expect(element.getAttribute('redirecturi')).to.equal(URI1);

          const URI2 = "https://local.testing/callback/2222";
          element.redirecturi = URI2;
          expect(element.redirecturi).to.equal(URI2);
          expect(element.getAttribute('redirecturi')).to.equal(URI2);

        });

        test('setting a clientid persists to localStorage', () => {
          const element = fixture('BasicTestFixture');

          // Verify persistance using propery setter
          const ID1 = '1111';
          element.clientid = ID1;
          expect(localStorage.getItem(element.storageKeys.id)).to.equal(ID1);

          // Verify persistance using attribute setter
          const ID2 = '2222';
          element.setAttribute('clientid', ID2);
          expect(localStorage.getItem(element.storageKeys.id)).to.equal(ID2);

        });

        test('setting a redirect URI on the element converts it to an absolute URL', () => {
          const element = fixture('BasicTestFixture');

          // The default is to redirect back to this page
          expect(element.redirecturi).to.equal(location.href);

          // Appends the path to the current location
          const relative = (path) => location.href.substring(0, location.href.lastIndexOf("/") + 1) + path;

          // Creates an absolute url
          const absolute = (path) => location.origin + path;

          // Setting a relative path appends it to the current href
          const PATH1 = 'testing/1111/';
          element.redirecturi = PATH1
          expect(element.redirecturi).to.equal(relative(PATH1));

          // The above works using the attribute setter
          const PATH2 = 'testing/2222/';
          element.setAttribute('redirecturi', PATH2)
          expect(element.getAttribute('redirecturi')).to.equal(relative(PATH2));

          // Setting an absolute path appends it to the hostname
          const PATH3 = '/testing/3333/';
          element.redirecturi = PATH3;
          expect(element.redirecturi).to.equal(absolute(PATH3));

          // The above works using the attribute setter
          const PATH4 = '/testing/4444/';
          element.setAttribute('redirecturi', PATH4);
          expect(element.getAttribute('redirecturi')).to.equal(absolute(PATH4));

          // Setting another URL remains unchanged
          const PATH5 = 'https://local.testing/5555/';
          element.redirecturi = PATH5;
          expect(element.redirecturi).to.equal(PATH5);

          // The above works using the attribute setter
          const PATH6 = 'https://local.testing/6666/';
          element.setAttribute('redirecturi', PATH6);
          expect(element.getAttribute('redirecturi')).to.equal(PATH6);
        });

        
      });
    </script>

  </body>
</html>
